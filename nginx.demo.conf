user nginx; # switch to nginx user after supervisor starts the service as root to allow logging to /dev/stdout and /dev/stderr to work
worker_processes auto; # Automatically detect number of CPU cores
error_log /dev/stderr warn; # Dockerfile creates symbolic link to /dev/stderr for docker logs
pid /tmp/nginx.pid; # Process ID file location

events {
    worker_connections 4096; # Max simultaneous connections per worker process
    use epoll; # Efficient event notification for Linux
}

http {
    include /etc/nginx/mime.types; # Load MIME type definitions for file extensions
    default_type application/octet-stream; # Default MIME type for unknown files

    # Redirect all cache directories to /tmp (writable by unprivileged nginx user)
    client_body_temp_path /tmp/client_temp;
    proxy_temp_path /tmp/proxy_temp;
    fastcgi_temp_path /tmp/fastcgi_temp;
    uwsgi_temp_path /tmp/uwsgi_temp;
    scgi_temp_path /tmp/scgi_temp;

    server_tokens off; # Hide nginx version in headers (prevents version-specific attacks)
    sendfile on; # Use kernel sendfile() for faster file transfers
    tcp_nopush on; # Optimize packet transmission (only send full packets)
    tcp_nodelay on; # Disable Nagle's algorithm for low-latency
    keepalive_timeout 65; # Keep connections alive for 65 seconds

    # Increase map hash bucket size to handle longer domain names
    map_hash_bucket_size 128;

    # Nginx Logging setup TODO optimize for minitoring instance
    # log_format main '$remote_addr - $remote_user [$time_local] "$request" '
    #                 '$status $body_bytes_sent "$http_referer" '
    #                 '"$http_user_agent" "$http_x_forwarded_for"';

    gzip on; # Enable gzip compression
    gzip_vary on; # Add Vary: Accept-Encoding header
    gzip_proxied any; # Compress responses for proxied requests
    gzip_comp_level 6; # Compression level (1-9, higher = more CPU, smaller size)
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss; # File types to compress


    # Define the upstream server (your Docker container)
    upstream fiscalismia_backend {
        server 127.0.0.1:3002; # Express server runs on this address inside the container
        keepalive 32; # Keep 32 idle connections open to backend
        keepalive_timeout 60s; # Idle connection timeout
        keepalive_requests 100; # Max requests per keepalive connection before closing
    }

    server {
        listen 8443 ssl proxy_protocol; # expects layer 4 proxy-protocol v2 headers
        server_name backend.demo.fiscalismia.com;

        # TLS certificates copied to correct location via Dockerfile
        ssl_certificate     /etc/nginx/certs/fullchain.pem;
        ssl_certificate_key /etc/nginx/certs/privkey.pem;
        ssl_protocols       TLSv1.3;

        # Trust ingress from HAProxy /w added PROXY protocol v2 data
        set_real_ip_from 172.24.1.3;  # HAProxy internal IP production network
        set_real_ip_from 172.20.1.3;  # HAProxy internal IP demo network

        # Now $remote_addr contains the real client IP extracted from proxy protocol v2 header
        real_ip_header proxy_protocol;

        # For logging the real client IP
        access_log /dev/stdout combined; # Dockerfile creates symbolic link to /dev/stdout for docker logs

        client_max_body_size 10m; # max body size for client requests
        client_body_timeout 60s; # Timeout for reading client request body

        # Security headers are handled in helmet middleware. redundant / duplicates
        # add_header X-Frame-Options "SAMEORIGIN" always; # Prevent clickjacking attacks
        # add_header X-Content-Type-Options "nosniff" always; # Prevent MIME-sniffing attacks
        # add_header X-XSS-Protection "1; mode=block" always; # Enable XSS filter in older browsers

        location / {
            proxy_set_header Host $http_host; # Forward original Host header to backend

            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_protocol_addr;# Chain of proxy IPs
            proxy_set_header X-Real-IP $remote_addr; # Send client's real IP address
            proxy_set_header X-Forwarded-Proto $scheme; # Original protocol (http/https)
            proxy_set_header Connection ""; # Clear Connection header for keepalive
            proxy_http_version 1.1; # Use HTTP/1.1 for upstream (required for keepalive)

            proxy_read_timeout 90s; # timeout before nginx throws 504 Gateway Time-out
            proxy_connect_timeout 10s; # Timeout for establishing connection to backend
            proxy_send_timeout 60s; # Timeout for sending request to backend

            proxy_redirect off; # Don't rewrite Location/Refresh headers from backend
            proxy_buffering off; # Useful for streaming responses

            proxy_pass http://fiscalismia_backend; # Pass requests to the upstream server
        }
    }
}
